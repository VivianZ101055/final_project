---
title: "ms_5.Rmd"
author: "Vivian Zhang"
date: "3/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(readxl)
library(janitor)
library(rvest)
library(magrittr)
library(base)
library(reshape2)
library(shiny)
# library(ggmap)
# library(mapproj)
# library(rworldmap)
# library(rworldxtra)
library(plotly)
library(leaflet)
library(tidyverse)

```

# Comments for Milestone 5

I worked quite a bit on my graphs this week. First, I cleaned my data because I noticed that after a few inner_join runs, some values (such as remittances in usd) remained static from 1980-2018. This was because I also needed to join columns by year, not just country name. I created a new column in my full_data dataframe that looks at the sum of remittances (in usd) in all EU member states in any given year from 1980 to 2018. Initially, the y axis showed what looked like scientific notation because the numbers were quite large and unwieldy. I play with scale_y_continuous to make it clearer. I decided to add both geom_line and geom_plot, so as to allow the user to hover over specific discrete points as well as see the overall trend of the data. In order to allow the hover feature to work, I learned more about the shiny toolkit. I spent some time experimenting with maps. At first, I tried a Google Maps API key, but after looking through more past projects, I decided to use leaflet. I figured out how to zoom into Europe specifically. Then, I experimented with the Shiny slider that allowed the user to select the year. I am currently working on addPolygons and trying to figure out which data input I need to create a choropleth map for remittances in usd. I will need to read more about spatial data in order to do so - somehow, I will need to communicate the country names as coordinates, so that I can match countries on the map with the country names I have in my full_data dataset. I already noticed that the countries are named differently between the leaflet map and my dataset. I am happy with the progress I have made so far; I spent quite a bit of time reading about leaflet and how to map my data, so hopefully the mapping won't be too difficult.


```{r member states}

eumemberinfo <- read_html('https://en.wikipedia.org/wiki/Member_state_of_the_European_Union', skip = 0)

eumemberinfo <- eumemberinfo %>%
  html_nodes(xpath='//*[@id="mw-content-text"]/div/table[5]') %>%
  html_table()

eumemberinfo <- eumemberinfo[[1]]

# Removing Wikipedia annotations

eumemberinfo$Name <- str_remove_all(eumemberinfo$Name, "\\[.*\\]")

# Changing the names because Eastern European countries are labeled
# differently on the two datasets

eumemberinfo$Name[eumemberinfo$Name == "Czechia"] <- "Czech Republic"

eumemberinfo$Name[eumemberinfo$Name == "Slovakia"] <- "Slovak Republic"

name <- eumemberinfo %>% 
  select(Name) 

names(name) <- c("sender")
  
```

```{r dataset, include=FALSE}

# Load remittances in USD in a given country, in alphabetical order

usd <- read_excel("data/remittances_usd.xls", skip = 3)

# Trying to get rid of the x in front of the data
# Filter to only show between 1980 to present
# Repeatedly getting the error that argument "pattern" is missing, with no
# default
# Convert USD to Euros - maybe later

usd <- usd %>%
  pivot_longer(
    cols = `1980`:`2018`,
    names_to = "year",
    names_prefix = "yr"
               )

usd <- usd[,-c(5:25)]

# join this with the eumemberinfo to only look at member states

full_data <- usd %>%
  inner_join(eumemberinfo, by = c("Country Name" = "Name")) %>%
  rename(remittances_in_usd = value) %>%
  clean_names %>%
  filter(country_name %in% name$sender)

# Load remittances as percentage of GDP for a given country

percent_gdp <- read_excel("data/remittance_percentgdp.xls", skip = 3)

percent_gdp <- percent_gdp %>%
  pivot_longer(
    cols = `1980`:`2018`,
    names_to = "year",
    names_prefix = "yr") %>%
  rename(remittances_percent_gdp = value) %>%
  clean_names %>%
  filter(country_name %in% name$sender)

percent_gdp <- percent_gdp[,-c(5:25)]

# Join this with the previous data and select only the relevant columns

full_data <- full_data %>%
  inner_join(percent_gdp, by = c("country_name"="country_name", "year"="year"), suffix = c("_usd", "_gdp")) %>%
  select(country_name, country_code_usd, accession, year, remittances_in_usd, remittances_percent_gdp)

```

```{r remittance inflows}

# Load remittance inflows

remittance_inflows <- read_excel("data/remittance_inflows.xlsx", skip = 0)

# Pivot years into column, clean names, rename columns
# Filter for EU countries, remove columns

remittance_inflows <- remittance_inflows %>%
  pivot_longer(
    cols = `1980`:`2018`,
    names_to = "remittance_inflows",
    names_prefix = "yr") %>%
  clean_names %>%
  rename(remmitance_inflows=value, year=remittance_inflows, country_name = migrant_remittance_inflows_us_million) %>%
  filter(country_name %in% name$sender) %>%
  select(-c(x2019e, remittances_as_a_share_of_gdp_in_2019_percent))

# Join into full dataset

full_data <- full_data %>%
  inner_join(remittance_inflows, by = c("country_name"="country_name", "year"="year"))

# <- data[ -c(19:22) ] %>%
# na.omit()

```

```{r plot}

# Get my data from full_data
# Add a new column called sum_remittance_usd
# ungroup and cast year into a numeric

mydata <- full_data %>%
  na.omit %>%
  group_by(year) %>%
  summarize(sum_remittance_usd = sum(remittances_in_usd)) %>%
  ungroup() %>%
  mutate(year = as.numeric(as.character(year)))

# to enable shiny toolkit, use fluidPage

ui <- fluidPage(
  plotlyOutput("distPlot")
)

# defining server for shinyApp function

server <- function(input, output) {
  output$distPlot <- renderPlotly({
    ggplot(mydata, aes(x = year, y = sum_remittance_usd)) +
      geom_line() +
      geom_point() +
      labs(title = "Total remittances flowing into the EU, by year",
           # subtitle = "Plotting Remittances in USD, from 1980-2018",
           # caption = "Source: World Bank",
           x = "Year",
           y = "Total Remittances (in Billions of USD)") +
      scale_x_continuous(limits = c(1980, 2018),
                         breaks = c(1980, 1985, 1990, 1995, 2000, 2005, 2010,
                                    2015),
                         labels = c("1980", "1985", "1990", "1995", 
                                    "2000", "2005", "2010",
                                    "2015")) +
      scale_y_continuous(limits = c(0, 120000000000),
                         breaks = c(0, 10000000000, 20000000000, 30000000000,
                                    40000000000, 50000000000, 60000000000,
                                    70000000000, 80000000000, 90000000000,
                                    100000000000, 110000000000, 120000000000),
                         labels = c("0", "10", "20", "30", "40", "50", "60", "70", "80",
                                    "90", "100", "110", "120")) +
  theme_classic() %>%
      add_trace(hovertemplate = "Year: $%{x}", "Total Remittances: $%{y}")
  })
}

shinyApp(ui = ui, server = server)

```